jQuery.fn.addcopy=function(e){var c={middle:' <a href="'+window.location.href+'">'+window.location.href+"</a> ",footer:'<br/>Source: <a href="'+window.location.href+'">'+window.location.href+"</a>",minlen:25};$.extend(c,e);var a=function(){var h=document.createElement("span");h.className="addcopy-mid";h.innerHTML=c.middle;return h};var f=function(){var h=document.createElement("span");h.className="addcopy-foot";h.innerHTML=c.footer;return h};var g=function(j,h){var k=$(j).parents().andSelf();while(h){var i=k.index(h);if(i!==-1){return h}h=h.parentNode}return null};var d=function(m,h){var i=g(m,h);var k=[];while(m.parentNode!==i){var j=m;while(j.nextSibling){k.push(j=j.nextSibling)}m=m.parentNode}var l=[];while(h.parentNode!==i){var j=h;while(j.previousSibling){l.push(j=j.previousSibling)}h=h.parentNode}l.reverse();while((m=m.nextSibling)!==h){k.push(m)}return k.concat(l)};var b=function(){var l=rangy.getSelection();var s=l.toString();if(!s||s.length<c.minlen){return}var i=[];var p=0;var m=function(x,v,w){if(x.nodeType!=3){return}var y=x.nodeValue;if(v!=undefined){y=y.slice(v)}else{v=0}if(w!=undefined){y=y.slice(0,w-v)}y.replace(/(\. )|(, )|(\? )|(! )|(- )|(: )/g,function(B){var A=arguments[arguments.length-2];var z=v+A;var C=p+z;i.push([x,z+2,C+2]);return B});p+=y.length};var j=function(v){if(v.nodeType==3){m(v)}else{$.each(v.childNodes,function(){j(this)})}};var q=l.getRangeAt(0);if(q.startContainer!=q.endContainer){m(q.startContainer,q.startOffset);var h=d(q.startContainer,q.endContainer);$(h).each(function(){j(this)});m(q.endContainer,undefined,q.endOffset)}else{m(q.startContainer,q.startOffset,q.endOffset)}var n=function(z,B,C){if(z.nodeType!=3){return}var A=z.nodeValue;var y=A.slice(0,B);var x=A.slice(B);var w=document.createTextNode(y);var v=document.createTextNode(x);$(z).before(w);$(z).before(C);$(z).before(v);if(z==q.startContainer){q.setStart(w,q.startOffset)}if(z==q.endContainer){q.setEnd(v,q.endOffset-y.length)}$(z).remove()};if(i.length>0){var o=p/2;var r=0;$.each(i,function(v,w){var y=w[2];var x=i[r][2];if(Math.abs(o-y)<Math.abs(o-x)){r=v}});var u=i[r];n(u[0],u[1],a())}if(c.footer){var k=q.cloneRange();k.collapse(false);var t=f();k.insertNode(t);q.setEndAfter(t)}l.removeAllRanges();l.addRange(q)};return this.mousedown(function(){$(".addcopy-mid").remove();$(".addcopy-foot").remove()}).mouseup(function(){if($.browser.opera){setTimeout(b,20)}else{b()}})};